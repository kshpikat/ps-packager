/*
Pre-requisites:
- Credentials for GitHub user which has access rights to sugarcrm repositories need to be configured in Jenkins as Username/Password Credentials with ID "GitHub Sugar User"
- GitHub Token for user which has access rights to sugarcrm repositories need to be configured in Jenkins as Secret Text with ID "GitHub Token"
- Credentials for Sugar FTP Server need to be configured with ID "PS FTP User"
- Text Finder plugin needs to be installed on Jenkins
- Git needs to be installed on Jenkins Worker
- Pyhton 3 needs to installed on Jenkins worker
- Rsync needs to be installed on Jenkins worker
*/

pipeline {
    agent any
    parameters {
        string(name: 'BASE_BRANCH', defaultValue: '11_3_base', description: 'Branch containing the base code')
        string(name: 'TARGET_BRANCH', defaultValue: 'attb_113_phase1', description: 'Branch containing the target code')
        string(name: 'GIT_REPO', defaultValue: 'git@github.com:sugarcrm-ps/ps-dev-attb', description: 'Git repository of the Project')
        string(name: 'SUGAR_VERSION', defaultValue: '11.*', description: 'Sugar version')
        string(name: 'MANIFEST_DESCRIPTION', defaultValue: 'Generated Sugar Package', description: 'Description of the Sugar Package')
        string(name: 'PACKAGE_NAME', defaultValue: 'Package', description: 'Name of the Sugar Package')
        string(name: 'BACKUP_NAME', defaultValue: 'cht-dev.sugaropencloud.tar.gz', description: 'Name of the backup file')
        choice(name: 'BACKUP_VERSION', choices: ['1130', '1200'],  description: 'Sugar Version of the backup')
    }
    options {
        // This is required if you want to clean before build
        skipDefaultCheckout(true)
    }
     stages {
        stage('Checkout') {
            steps {
                cleanWs()
                git branch: 'CI', credentialsId: 'GitHub Sugar User', url: 'https://github.com/nbleyh-sugarcrm/ps-packager'
            }
        }
        stage('Setup Sugar Instance') {
          steps {
            withCredentials([usernamePassword(credentialsId: 'PS FTP User', passwordVariable: 'pass', usernameVariable: 'user')]) {
                sh '''
                    python3 src/builder.py -b ${BACKUP_NAME} -u ${env.user} -p ${env.pass}
                '''
            }
          }
        }
        stage('Perform PHPUnit Tests') {
            steps {
                sh '''
                    docker exec sugar-web1 /bin/sh -c 'composer install && cd tests/unit-php && ../../vendor/bin/phpunit --log-junit results.xml'")
                '''
                junit 'data/sugar/results.xml'
            }
        }
        stage('Perform Healthcheck') {
            steps {
                sh '''
                    os.system("docker exec sugar-web1 php /var/www/html/upgrader/CliUpgrader.php -z /var/www/html/upgrade.zip -l /var/www/html/upgrader/health.log -s /var/www/html/sugar/ -u admin -S healthcheck")
                '''
                findText(
                    textFinders: [
                        textFinder (
                            regexp: '\\[yellow\\]',
                            fileSet: 'data/upgrader/health.log',
                            changeCondition: 'MATCH_FOUND',
                            alsoCheckConsoleOutput: false,
                            buildResult: 'UNSTABLE'
                        ),
                        textFinder (
                            regexp: '\\[red\\]',
                            fileSet: 'data/upgrader/health.log',
                            changeCondition: 'MATCH_FOUND',
                            alsoCheckConsoleOutput: false,
                            buildResult: 'FAILURE'
                        )
                    ]
                )
                archiveArtifacts artifacts: 'data/upgrader/health.log', onlyIfSuccessful: false
            }
        }
    }
}        
